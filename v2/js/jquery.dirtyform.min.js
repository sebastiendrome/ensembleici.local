/*!
	Copyright 2010 Mal Curtis
	https://github.com/snikch/jquery.dirtyforms
*/

if(typeof jQuery=="undefined")throw"jQuery Required";(function(a){a.extend({DirtyForms:{
    debug:false,
    message:'Vous avez fait des modifications sur cette page, qui n\'ont pas été sauvegardées. Si vous quittez cette page, ces changements ne seront pas enregistrés. (Cliquez sur le bouton "Suite" en bas de formulaire pour sauvegarder.)',
    title:"Êtes-vous sûr de vouloir quitter ?",
    dirtyClass:"dirty",listeningClass:"dirtylisten",ignoreClass:"ignoredirty",choiceContinue:false,helpers:[],dialog:{selector:"#cboxContent",fire:function(b,c){
        var d="<h3>"+c+"</h3>"+"<p>"+b+"</p>"+'<p class="boutons"><a id="stay" href="#stay" class="boutonbleu ico-flecheretour">Non, annuler</a><a href="#leave" id="leave" class="boutonbleu ico-fleche">Oui, quitter cette page</a>'+'</p>';
        a.colorbox({html:d,width:"500px",onComplete:function(){a(this).colorbox.resize()}})},bind:function(){var b=function(b){return function(c){c.preventDefault();a.colorbox.close();b(c)}};a("#stay").click(b(q));a("#cboxClose").click(b(q));a("#cboxOverlay").click(b(q));a("#leave").click(b(r))},refire:function(b,c){a.colorbox({html:b,width:"500px",height:"300px"})},stash:function(){if(a("#cboxContent").html!=""){return a("#cboxContent").clone(true)}else{return false}}},isDirty:function(){return a(":dirtylistening").dirtyForms("isDirty")},disable:function(){c.disabled=true},choiceCommit:function(a){p(a)},isDeciding:function(){return c.deciding},decidingContinue:function(a){r(a)},decidingCancel:function(a){q(a)},dirtylog:function(a){h(a)}}});a.extend(a.expr[":"],{dirtylistening:function(b){return a(b).hasClass(a.DirtyForms.listeningClass)},dirty:function(b){return a(b).hasClass(a.DirtyForms.dirtyClass)}});var b={init:function(){var b=a.DirtyForms;h("Adding forms to watch");i();return this.each(function(c){if(!a(this).is("form"))return;h("Adding form "+a(this).attr("id")+" to forms to watch");a(this).addClass(b.listeningClass);var g="textarea,input:not([type='checkbox'],[type='radio'],[type='button'],"+"[type='image'],[type='submit'],[type='reset'],[type='file'],[type='search'])";var i="input[type='checkbox'],input[type='radio'],select";var j="input[type='reset']";if(typeof a(document).on==="function"){a(this).on("focus change",g,f);a(this).on("change",i,e);a(this).on("click",j,d)}else{a(this).delegate(g,"focus change",f);a(this).delegate(i,"change",e);a(this).delegate(j,"click",d)}})},isDirty:function(){var b=false;var d=this;if(c.disabled)return false;if(g()){b=true;return true}this.each(function(c){if(a(this).hasClass(a.DirtyForms.dirtyClass)){b=true;return true}});a.each(a.DirtyForms.helpers,function(a,c){if("isDirty"in c){if(c.isDirty(d)){b=true;return true}}if("isNodeDirty"in c){if(c.isNodeDirty(d)){b=true;return true}}});h("isDirty returned "+b);return b},setDirty:function(){h("setDirty called");return this.each(function(b){a(this).addClass(a.DirtyForms.dirtyClass).parents("form").addClass(a.DirtyForms.dirtyClass)})},setClean:function(){h("setClean called");c.focused={element:false,value:false};return this.each(function(b){var c=this;a(c).removeClass(a.DirtyForms.dirtyClass);if(a(c).is("form")){a(c).find(":dirty").removeClass(a.DirtyForms.dirtyClass)}else{var d=a(c).parents("form");if(d.find(":dirty").length==0){d.removeClass(a.DirtyForms.dirtyClass)}}a.each(a.DirtyForms.helpers,function(a,b){if("setClean"in b){b.setClean(c)}})})}};a.fn.dirtyForms=function(c){if(b[c]){return b[c].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof c==="object"||!c){return b.init.apply(this,arguments)}else{a.error("Method "+c+" does not exist on jQuery.dirtyForms")}};a.fn.setDirty=function(){return this.dirtyForms("setDirty")};a.fn.isDirty=function(){return this.dirtyForms("isDirty")};a.fn.cleanDirty=function(){return this.dirtyForms("setClean")};var c=a.DirtyForms=a.extend({disabled:false,exitBound:false,formStash:false,dialogStash:false,deciding:false,decidingEvent:false,currentForm:false,hasFirebug:"console"in window&&"firebug"in window.console,hasConsoleLog:"console"in window&&"log"in window.console,focused:{element:false,value:false}},a.DirtyForms);var d=function(){a(this).parents("form").dirtyForms("setClean")};var e=function(){a(this).dirtyForms("setDirty")};var f=function(){element=a(this);if(g()){c.focused["element"].dirtyForms("setDirty")}c.focused["element"]=element;c.focused["value"]=element.val()};var g=function(){return c.focused["element"]&&c.focused["element"].val()!==c.focused["value"]};var h=function(b){if(!a.DirtyForms.debug)return;b="[DirtyForms] "+b;c.hasFirebug?console.log(b):c.hasConsoleLog?window.console.log(b):alert(b)};var i=function(){if(c.exitBound)return;var b=top!==self;if(typeof a(document).on==="function"){a(document).on("click","a",k);a(document).on("submit","form",l);if(b){a(top.document).on("click","a",k);a(top.document).on("submit","form",l)}}else{a(document).delegate("a","click",k);a(document).delegate("form","submit",l);if(b){a(top.document).delegate("a","click",k);a(top.document).delegate("form","submit",l)}}a(window).bind("beforeunload",m);if(b){a(top.window).bind("beforeunload",m)}c.exitBound=true};var j=function(){var b="";a.each(a.DirtyForms.helpers,function(a,c){if("ignoreAnchorSelector"in c){if(b.length>0){b+=","}b+=c.ignoreAnchorSelector}});return b};var k=function(b){if(!a(this).is(j())){n(b)}};var l=function(a){c.currentForm=this;n(a)};var m=function(a){var b=n(a);if(b&&c.doubleunloadfix!=true){h("Before unload will be called, resetting");c.deciding=false}c.doubleunloadfix=true;setTimeout(function(){c.doubleunloadfix=false},200);if(typeof b=="string"){a=a||window.event;if(a){a.returnValue=b}return b}};var n=function(b){h("Entering: Leaving Event fired, type: "+b.type+", element: "+b.target+", class: "+a(b.target).attr("class")+" and id: "+b.target.id);if(b.type=="beforeunload"&&c.doubleunloadfix){h("Skip this unload, Firefox bug triggers the unload event multiple times");c.doubleunloadfix=false;return false}if(a(b.target).hasClass(c.ignoreClass)||o(b)){h("Leaving: Element has ignore class or has target='_blank'");if(!b.isDefaultPrevented()){s()}return false}if(c.deciding){h("Leaving: Already in the deciding process");return false}if(b.isDefaultPrevented()){h("Leaving: Event has been stopped elsewhere");return false}if(!c.isDirty()){h("Leaving: Not dirty");if(!b.isDefaultPrevented()){s()}return false}if(b.type=="submit"&&a(b.target).dirtyForms("isDirty")){h("Leaving: Form submitted is a dirty form");if(!b.isDefaultPrevented()){s()}return true}c.deciding=true;c.decidingEvent=b;h("Setting deciding active");if(c.dialog!==false){h("Saving dialog content");c.dialogStash=c.dialog.stash();h(c.dialogStash)}a(document).trigger("defer.dirtyforms");if(b.type=="beforeunload"){h("Returning to beforeunload browser handler with: "+c.message);return c.message}if(!c.dialog)return;b.preventDefault();b.stopImmediatePropagation();if(a(b.target).is("form")&&a(b.target).parents(c.dialog.selector).length>0){h("Stashing form");c.formStash=a(b.target).clone(true).hide()}else{c.formStash=false}h("Deferring to the dialog");c.dialog.fire(a.DirtyForms.message,a.DirtyForms.title);c.dialog.bind()};var o=function(b){var c=a(b.target).attr("target");if(typeof c==="string"){c=c.toLowerCase()}return c==="_blank"};var p=function(b){if(c.deciding){a(document).trigger("choicecommit.dirtyforms");if(a.DirtyForms.choiceContinue){r(b)}else{q(b)}a(document).trigger("choicecommitAfter.dirtyforms")}};var q=function(b){b.preventDefault();a(document).trigger("decidingcancelled.dirtyforms");if(c.dialog!==false&&c.dialogStash!==false){h("Refiring the dialog with stashed content");c.dialog.refire(c.dialogStash.html(),b)}a(document).trigger("decidingcancelledAfter.dirtyforms");c.dialogStash=false;c.deciding=c.currentForm=c.decidingEvent=false};var r=function(b){window.onbeforeunload=null;b.preventDefault();c.dialogStash=false;a(document).trigger("decidingcontinued.dirtyforms");t(c.decidingEvent);c.deciding=c.currentForm=c.decidingEvent=false};var s=function(){h("Clearing the beforeunload event");a(window).unbind("beforeunload",m);window.onbeforeunload=null};var t=function(b){a(document).trigger("beforeRefire.dirtyforms");switch(b.type){case"click":h("Refiring click event");var d=new jQuery.Event("click");a(b.target).trigger(d);if(!d.isDefaultPrevented()){var e=a(b.target).closest("[href]");h("Sending location to "+e.attr("href"));location.href=e.attr("href");return}break;default:h("Refiring "+b.type+" event on "+b.target);var f;if(c.formStash){h("Appending stashed form to body");f=c.formStash;a("body").append(f)}else{f=a(b.target);if(!f.is("form"))f=f.closest("form")}f.trigger(b.type);break}}})(jQuery)